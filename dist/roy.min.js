/* roy.js 
 * Wed, 27 Nov 2013 10:55:00 +0000 
 * (c) 2013 Johannes J. Schmidt, TF */
!function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);throw new Error("Cannot find module '"+o+"'")}var f=n[o]={exports:{}};t[o][0].call(f.exports,function(e){var n=t[o][1][e];return s(n?n:e)},f,f.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module){var Crypto={};!function(){Crypto.MD5=function(string){function RotateLeft(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits}function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;return lX8=2147483648&lX,lY8=2147483648&lY,lX4=1073741824&lX,lY4=1073741824&lY,lResult=(1073741823&lX)+(1073741823&lY),lX4&lY4?2147483648^lResult^lX8^lY8:lX4|lY4?1073741824&lResult?3221225472^lResult^lX8^lY8:1073741824^lResult^lX8^lY8:lResult^lX8^lY8}function F(x,y,z){return x&y|~x&z}function G(x,y,z){return x&z|y&~z}function H(x,y,z){return x^y^z}function I(x,y,z){return y^(x|~z)}function FF(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function ConvertToWordArray(string){for(var lWordCount,lMessageLength=string.length,lNumberOfWords_temp1=lMessageLength+8,lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64,lNumberOfWords=16*(lNumberOfWords_temp2+1),lWordArray=Array(lNumberOfWords-1),lBytePosition=0,lByteCount=0;lMessageLength>lByteCount;)lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|string.charCodeAt(lByteCount)<<lBytePosition,lByteCount++;return lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=lByteCount%4*8,lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition,lWordArray[lNumberOfWords-2]=lMessageLength<<3,lWordArray[lNumberOfWords-1]=lMessageLength>>>29,lWordArray}function WordToHex(lValue){var lByte,lCount,WordToHexValue="",WordToHexValue_temp="";for(lCount=0;3>=lCount;lCount++)lByte=lValue>>>8*lCount&255,WordToHexValue_temp="0"+lByte.toString(16),WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);return WordToHexValue}var k,AA,BB,CC,DD,a,b,c,d,x=Array(),S11=7,S12=12,S13=17,S14=22,S21=5,S22=9,S23=14,S24=20,S31=4,S32=11,S33=16,S34=23,S41=6,S42=10,S43=15,S44=21;for(x=ConvertToWordArray(string),a=1732584193,b=4023233417,c=2562383102,d=271733878,k=0;k<x.length;k+=16)AA=a,BB=b,CC=c,DD=d,a=FF(a,b,c,d,x[k+0],S11,3614090360),d=FF(d,a,b,c,x[k+1],S12,3905402710),c=FF(c,d,a,b,x[k+2],S13,606105819),b=FF(b,c,d,a,x[k+3],S14,3250441966),a=FF(a,b,c,d,x[k+4],S11,4118548399),d=FF(d,a,b,c,x[k+5],S12,1200080426),c=FF(c,d,a,b,x[k+6],S13,2821735955),b=FF(b,c,d,a,x[k+7],S14,4249261313),a=FF(a,b,c,d,x[k+8],S11,1770035416),d=FF(d,a,b,c,x[k+9],S12,2336552879),c=FF(c,d,a,b,x[k+10],S13,4294925233),b=FF(b,c,d,a,x[k+11],S14,2304563134),a=FF(a,b,c,d,x[k+12],S11,1804603682),d=FF(d,a,b,c,x[k+13],S12,4254626195),c=FF(c,d,a,b,x[k+14],S13,2792965006),b=FF(b,c,d,a,x[k+15],S14,1236535329),a=GG(a,b,c,d,x[k+1],S21,4129170786),d=GG(d,a,b,c,x[k+6],S22,3225465664),c=GG(c,d,a,b,x[k+11],S23,643717713),b=GG(b,c,d,a,x[k+0],S24,3921069994),a=GG(a,b,c,d,x[k+5],S21,3593408605),d=GG(d,a,b,c,x[k+10],S22,38016083),c=GG(c,d,a,b,x[k+15],S23,3634488961),b=GG(b,c,d,a,x[k+4],S24,3889429448),a=GG(a,b,c,d,x[k+9],S21,568446438),d=GG(d,a,b,c,x[k+14],S22,3275163606),c=GG(c,d,a,b,x[k+3],S23,4107603335),b=GG(b,c,d,a,x[k+8],S24,1163531501),a=GG(a,b,c,d,x[k+13],S21,2850285829),d=GG(d,a,b,c,x[k+2],S22,4243563512),c=GG(c,d,a,b,x[k+7],S23,1735328473),b=GG(b,c,d,a,x[k+12],S24,2368359562),a=HH(a,b,c,d,x[k+5],S31,4294588738),d=HH(d,a,b,c,x[k+8],S32,2272392833),c=HH(c,d,a,b,x[k+11],S33,1839030562),b=HH(b,c,d,a,x[k+14],S34,4259657740),a=HH(a,b,c,d,x[k+1],S31,2763975236),d=HH(d,a,b,c,x[k+4],S32,1272893353),c=HH(c,d,a,b,x[k+7],S33,4139469664),b=HH(b,c,d,a,x[k+10],S34,3200236656),a=HH(a,b,c,d,x[k+13],S31,681279174),d=HH(d,a,b,c,x[k+0],S32,3936430074),c=HH(c,d,a,b,x[k+3],S33,3572445317),b=HH(b,c,d,a,x[k+6],S34,76029189),a=HH(a,b,c,d,x[k+9],S31,3654602809),d=HH(d,a,b,c,x[k+12],S32,3873151461),c=HH(c,d,a,b,x[k+15],S33,530742520),b=HH(b,c,d,a,x[k+2],S34,3299628645),a=II(a,b,c,d,x[k+0],S41,4096336452),d=II(d,a,b,c,x[k+7],S42,1126891415),c=II(c,d,a,b,x[k+14],S43,2878612391),b=II(b,c,d,a,x[k+5],S44,4237533241),a=II(a,b,c,d,x[k+12],S41,1700485571),d=II(d,a,b,c,x[k+3],S42,2399980690),c=II(c,d,a,b,x[k+10],S43,4293915773),b=II(b,c,d,a,x[k+1],S44,2240044497),a=II(a,b,c,d,x[k+8],S41,1873313359),d=II(d,a,b,c,x[k+15],S42,4264355552),c=II(c,d,a,b,x[k+6],S43,2734768916),b=II(b,c,d,a,x[k+13],S44,1309151649),a=II(a,b,c,d,x[k+4],S41,4149444226),d=II(d,a,b,c,x[k+11],S42,3174756917),c=II(c,d,a,b,x[k+2],S43,718787259),b=II(b,c,d,a,x[k+9],S44,3951481745),a=AddUnsigned(a,AA),b=AddUnsigned(b,BB),c=AddUnsigned(c,CC),d=AddUnsigned(d,DD);var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase()}}(),"undefined"!=typeof module&&module.exports&&(module.exports=Crypto)},{}],2:[function(require,module){var uuid;!function(){var CHARS="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");uuid=function(len,radix){var i,chars=CHARS,uuidInner=[];if(radix=radix||chars.length,len)for(i=0;len>i;i++)uuidInner[i]=chars[0|Math.random()*radix];else{var r;for(uuidInner[8]=uuidInner[13]=uuidInner[18]=uuidInner[23]="-",uuidInner[14]="4",i=0;36>i;i++)uuidInner[i]||(r=0|16*Math.random(),uuidInner[i]=chars[19==i?3&r|8:r])}return uuidInner.join("")}}(),"undefined"!=typeof module&&module.exports&&(module.exports=uuid)},{}],3:[function(require,module){"use strict";var verifyPeers=require("./prepare/verify-peers"),getPeersInformaton=require("./prepare/get-peers-information"),generateReplicationId=require("./prepare/generate-replication-id"),findCommonAncestry=require("./prepare/find-common-ancestry"),async=require("async");module.exports=function(options,config,state,callback){function run(action,next){action(options,config,state,next)}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),async.eachSeries([verifyPeers,getPeersInformaton,generateReplicationId,findCommonAncestry],run,function(err){return err?callback(err):(callback(null,{ok:!0}),void 0)})}},{"./prepare/find-common-ancestry":4,"./prepare/generate-replication-id":5,"./prepare/get-peers-information":6,"./prepare/verify-peers":7,async:14}],4:[function(require,module){"use strict";var async=require("async");module.exports=function(options,config,state,callback){function getReplicationDoc(db,next){db.get("_local/"+state.id,function(err,doc){return err&&"not_found"===err.error?next(null,null):(next(err,doc),void 0)})}function compare(source,target){if(!source||!target)return null;if(source.session_id===target.session_id)return source.source_last_seq;var histories=source.history.filter(function(sourceHistory){var targetHistories=target.history.filter(function(targetHistory){return targetHistory.session_id===sourceHistory.session_id});return targetHistories.length});return histories.length?histories[0].recorded_seq:null}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),async.map([options.source,options.target],getReplicationDoc,function(err,response){return err?callback(err):(state.replicationDocs={source:response[0],target:response[1]},state.start_last_seq=compare(response[0],response[1]),callback(null,{ok:!0,start_last_seq:state.start_last_seq}),void 0)})}},{async:14}],5:[function(require,module){"use strict";var Crypto=require("../../deps/md5");module.exports=function(options,config,state,callback){function getFilter(callback){if(!options.filter)return callback(null,null);var ddocName=options.filter.split("/",1)[0];options.source.get("_design/"+ddocName,function(err,ddoc){if(err)return callback(err);var filterName=options.filter.split("/",2)[1];return ddoc.filters&&ddoc.filters[filterName]?(callback(null,ddoc.filters[filterName]),void 0):callback({error:"not_found",reason:"missing json key: "+filterName})})}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={});var id=[];id.push(config.id),id.push(options.source.id()),id.push(options.target.id()),getFilter(function(err,filter){return err?callback(err):(filter&&id.push(filter),options.query_params&&id.push(JSON.stringify(options.query_params)),options.doc_ids&&id.push(JSON.stringify(options.doc_ids)),state.id_version=3,state.id=Crypto.MD5(id.join("")),callback(null,{ok:!0,version:state.id_version,id:state.id}),void 0)})}},{"../../deps/md5":1}],6:[function(require,module){"use strict";var async=require("async");module.exports=function(options,config,state,callback){function info(db,next){db.info(next)}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),async.map([options.source,options.target],info,function(err,response){return err?callback(err):(callback(null,{ok:!0,source:response[0],target:response[1]}),void 0)})}},{async:14}],7:[function(require,module){"use strict";var async=require("async");module.exports=function(options,config,state,callback){function exist(db,next){db.exists(next)}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),async.map([options.source,options.target],exist,function(err,response){if(err)return callback(err);var sourceExists=response[0].ok;if(!sourceExists)return callback({error:"db_not_found",reason:"could not open source"});var targetExists=response[1].ok;return targetExists?(callback(null,{ok:!0}),void 0):options.create_target?options.target.create(function(err){return err?callback(err):(callback(null,{ok:!0}),void 0)}):callback({error:"db_not_found",reason:"could not open target"})})}},{async:14}],8:[function(require,module){"use strict";var locateChangedDocuments=require("./replicate/locate-changed-documents"),fetchChangedDocuments=require("./replicate/fetch-changed-documents"),uploadDocuments=require("./replicate/upload-documents"),ensureFullCommit=require("./replicate/ensure-full-commit"),recordReplicationCheckpoint=require("./replicate/record-replication-checkpoint"),async=require("async");module.exports=function(options,config,state,callback){function replicate(){function run(action,next){action(options,config,state,next)}async.eachSeries([locateChangedDocuments,fetchChangedDocuments,uploadDocuments,ensureFullCommit,recordReplicationCheckpoint],run,function(err){return err?callback(err):replicatedOnce&&!state.missing_checked?callback(null,{ok:!0,no_changes:!state.missing_checked}):replicatedOnce&&lastMissingChecked===state.missing_checked?callback(null,{ok:!0,session_id:state.session_id,source_last_seq:state.end_last_seq,replication_id_version:state.id_version,history:[{session_id:state.session_id,start_time:state.start_time,end_time:new Date,start_last_seq:state.start_last_seq,end_last_seq:state.end_last_seq,recorded_seq:state.recorded_seq,missing_checked:state.missing_checked,missing_found:state.missing_found,docs_read:state.docs_read,docs_written:state.docs_written,doc_write_failures:state.doc_write_failures}]}):(replicatedOnce=!0,lastMissingChecked=state.missing_checked,replicate(),void 0)})}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={});var replicatedOnce=!1,lastMissingChecked=state.missing_checked;replicate()}},{"./replicate/ensure-full-commit":9,"./replicate/fetch-changed-documents":10,"./replicate/locate-changed-documents":11,"./replicate/record-replication-checkpoint":12,"./replicate/upload-documents":13,async:14}],9:[function(require,module){"use strict";module.exports=function(options,config,state,callback){"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),options.target.ensureFullCommit(function(err){return err?callback(err):(callback(null,{ok:!0}),void 0)})}},{}],10:[function(require,module){"use strict";var async=require("async");module.exports=function(options,config,state,callback){function fetch(id,next){options.source.get(id,{revs:!0,open_revs:JSON.stringify(state.changedDocs[id].missing),attachments:!0,latest:!0},next)}if("function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),!state.changedDocs)return state.docs=[],callback(null,{ok:!0,docs:state.docs});var ids=Object.keys(state.changedDocs);return ids.length?(async.mapLimit(ids,config.max_requests||100,fetch,function(err,docs){return err?callback(err):(state.docs=docs,state.docs_read+=docs.length,callback(null,{ok:!0,docs:state.docs}),void 0)}),void 0):(state.docs=[],callback(null,{ok:!0,docs:state.docs}))}},{async:14}],11:[function(require,module){"use strict";module.exports=function(options,config,state,callback){"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={});var changesOptions={style:"all_docs"};config.batch_size&&(changesOptions.limit=config.batch_size),(state.end_last_seq||state.start_last_seq)&&(changesOptions.since=state.end_last_seq||state.start_last_seq),options.continuous&&(changesOptions.feed="continuous",changesOptions.heartbeat=config.heartbeat),options.filter&&(changesOptions.filter=options.filter),options.query_params&&(changesOptions.query_params=options.query_params),options.doc_ids&&(changesOptions.doc_ids=options.doc_ids),options.source.changes(changesOptions,function(err,response){if(err)return callback(err);if(state.end_last_seq=response.last_seq,!response.results.length)return state.changedDocs=[],callback(null,{ok:!0,changedDocs:state.changedDocs});state.missing_checked=response.results.reduce(function(sum,result){return sum+result.changes.length},state.missing_checked);var revs=response.results.reduce(function(memo,result){return memo[result.id]=result.changes.map(function(change){return change.rev}),memo},{});options.target.revsDiff(revs,function(err,changedDocs){return err?callback(err):(state.changedDocs=changedDocs,state.missing_found=Object.keys(changedDocs).reduce(function(sum,key){return sum+changedDocs[key].missing.length},state.missing_found),callback(null,{ok:!0,changedDocs:state.changedDocs}),void 0)})})}},{}],12:[function(require,module){"use strict";var async=require("async");module.exports=function(options,config,state,callback){function saveReplicationDoc(ep,next){ep.doc.session_id=history.session_id,ep.doc.source_last_seq=history.recorded_seq,ep.doc.history=ep.doc.history||[],ep.doc.history.unshift(history),ep.db.put(ep.doc,function(err,doc){return err&&"not_found"===err.error?next(null,null):(next(err,doc),void 0)})}"function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={});var history={session_id:state.session_id,start_time:state.start_time,end_time:new Date,missing_checked:state.missing_checked,missing_found:state.missing_found,docs_read:state.docs?state.docs.length:0,docs_written:state.docs?state.docs.length:0,doc_write_failures:0,start_last_seq:state.start_last_seq,recorded_seq:state.end_last_seq,end_last_seq:state.end_last_seq};state.replicationDocs=state.replicationDocs||{},state.replicationDocs.source||(state.replicationDocs.source={_id:"_local/"+state.id,replication_id_version:state.id_version}),state.replicationDocs.target||(state.replicationDocs.target={_id:"_local/"+state.id,replication_id_version:state.id_version}),async.map([{db:options.source,doc:state.replicationDocs.source},{db:options.target,doc:state.replicationDocs.target}],saveReplicationDoc,function(err,response){return err?callback(err):(state.recorded_seq=state.end_last_seq,state.replicationDocs.source._rev=response[0].rev,state.replicationDocs.target._rev=response[1].rev,callback(null,{ok:!0,replicationDocs:state.replicationDocs}),void 0)})}},{async:14}],13:[function(require,module){"use strict";module.exports=function(options,config,state,callback){function upload(body,next){var docs=body.reduce(function(memo,arr){return arr.reduce(function(m,d){return d.ok&&m.push(d.ok),m},memo)},[]);options.target.bulkDocs({new_edits:!1,docs:docs},next)}if("function"==typeof config&&(callback=config,config={},state={}),"function"==typeof state&&(callback=state,state={}),!state.docs)return callback(null,{ok:!0});var uploadedDocs=state.docs;upload(uploadedDocs,function(err){return err?callback(err):(state.uploadedDocs=state.docs,state.docs_written+=uploadedDocs.length,callback(null,{ok:!0,uploadedDocs:state.uploadedDocs}),void 0)})}},{}],14:[function(require,module){var process=require("__browserify_process");!function(){function only_once(fn){var called=!1;return function(){if(called)throw new Error("Callback was already called.");called=!0,fn.apply(root,arguments)}}var root,previous_async,async={};root=this,null!=root&&(previous_async=root.async),async.noConflict=function(){return root.async=previous_async,async};var _each=function(arr,iterator){if(arr.forEach)return arr.forEach(iterator);for(var i=0;i<arr.length;i+=1)iterator(arr[i],i,arr)},_map=function(arr,iterator){if(arr.map)return arr.map(iterator);var results=[];return _each(arr,function(x,i,a){results.push(iterator(x,i,a))}),results},_reduce=function(arr,iterator,memo){return arr.reduce?arr.reduce(iterator,memo):(_each(arr,function(x,i,a){memo=iterator(memo,x,i,a)}),memo)},_keys=function(obj){if(Object.keys)return Object.keys(obj);var keys=[];for(var k in obj)obj.hasOwnProperty(k)&&keys.push(k);return keys};"undefined"!=typeof process&&process.nextTick?(async.nextTick=process.nextTick,async.setImmediate="undefined"!=typeof setImmediate?setImmediate:async.nextTick):"function"==typeof setImmediate?(async.nextTick=function(fn){setImmediate(fn)},async.setImmediate=async.nextTick):(async.nextTick=function(fn){setTimeout(fn,0)},async.setImmediate=async.nextTick),async.each=function(arr,iterator,callback){if(callback=callback||function(){},!arr.length)return callback();var completed=0;_each(arr,function(x){iterator(x,only_once(function(err){err?(callback(err),callback=function(){}):(completed+=1,completed>=arr.length&&callback(null))}))})},async.forEach=async.each,async.eachSeries=function(arr,iterator,callback){if(callback=callback||function(){},!arr.length)return callback();var completed=0,iterate=function(){iterator(arr[completed],function(err){err?(callback(err),callback=function(){}):(completed+=1,completed>=arr.length?callback(null):iterate())})};iterate()},async.forEachSeries=async.eachSeries,async.eachLimit=function(arr,limit,iterator,callback){var fn=_eachLimit(limit);fn.apply(null,[arr,iterator,callback])},async.forEachLimit=async.eachLimit;var _eachLimit=function(limit){return function(arr,iterator,callback){if(callback=callback||function(){},!arr.length||0>=limit)return callback();var completed=0,started=0,running=0;!function replenish(){if(completed>=arr.length)return callback();for(;limit>running&&started<arr.length;)started+=1,running+=1,iterator(arr[started-1],function(err){err?(callback(err),callback=function(){}):(completed+=1,running-=1,completed>=arr.length?callback():replenish())})}()}},doParallel=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.each].concat(args))}},doParallelLimit=function(limit,fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[_eachLimit(limit)].concat(args))}},doSeries=function(fn){return function(){var args=Array.prototype.slice.call(arguments);return fn.apply(null,[async.eachSeries].concat(args))}},_asyncMap=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(err,v){results[x.index]=v,callback(err)})},function(err){callback(err,results)})};async.map=doParallel(_asyncMap),async.mapSeries=doSeries(_asyncMap),async.mapLimit=function(arr,limit,iterator,callback){return _mapLimit(limit)(arr,iterator,callback)};var _mapLimit=function(limit){return doParallelLimit(limit,_asyncMap)};async.reduce=function(arr,memo,iterator,callback){async.eachSeries(arr,function(x,callback){iterator(memo,x,function(err,v){memo=v,callback(err)})},function(err){callback(err,memo)})},async.inject=async.reduce,async.foldl=async.reduce,async.reduceRight=function(arr,memo,iterator,callback){var reversed=_map(arr,function(x){return x}).reverse();async.reduce(reversed,memo,iterator,callback)},async.foldr=async.reduceRight;var _filter=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(v){v&&results.push(x),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.filter=doParallel(_filter),async.filterSeries=doSeries(_filter),async.select=async.filter,async.selectSeries=async.filterSeries;var _reject=function(eachfn,arr,iterator,callback){var results=[];arr=_map(arr,function(x,i){return{index:i,value:x}}),eachfn(arr,function(x,callback){iterator(x.value,function(v){v||results.push(x),callback()})},function(){callback(_map(results.sort(function(a,b){return a.index-b.index}),function(x){return x.value}))})};async.reject=doParallel(_reject),async.rejectSeries=doSeries(_reject);var _detect=function(eachfn,arr,iterator,main_callback){eachfn(arr,function(x,callback){iterator(x,function(result){result?(main_callback(x),main_callback=function(){}):callback()})},function(){main_callback()})};async.detect=doParallel(_detect),async.detectSeries=doSeries(_detect),async.some=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){v&&(main_callback(!0),main_callback=function(){}),callback()})},function(){main_callback(!1)})},async.any=async.some,async.every=function(arr,iterator,main_callback){async.each(arr,function(x,callback){iterator(x,function(v){v||(main_callback(!1),main_callback=function(){}),callback()})},function(){main_callback(!0)})},async.all=async.every,async.sortBy=function(arr,iterator,callback){async.map(arr,function(x,callback){iterator(x,function(err,criteria){err?callback(err):callback(null,{value:x,criteria:criteria})})},function(err,results){if(err)return callback(err);var fn=function(left,right){var a=left.criteria,b=right.criteria;return b>a?-1:a>b?1:0};callback(null,_map(results.sort(fn),function(x){return x.value}))})},async.auto=function(tasks,callback){callback=callback||function(){};var keys=_keys(tasks);if(!keys.length)return callback(null);var results={},listeners=[],addListener=function(fn){listeners.unshift(fn)},removeListener=function(fn){for(var i=0;i<listeners.length;i+=1)if(listeners[i]===fn)return listeners.splice(i,1),void 0},taskComplete=function(){_each(listeners.slice(0),function(fn){fn()})};addListener(function(){_keys(results).length===keys.length&&(callback(null,results),callback=function(){})}),_each(keys,function(k){var task=tasks[k]instanceof Function?[tasks[k]]:tasks[k],taskCallback=function(err){var args=Array.prototype.slice.call(arguments,1);if(args.length<=1&&(args=args[0]),err){var safeResults={};_each(_keys(results),function(rkey){safeResults[rkey]=results[rkey]}),safeResults[k]=args,callback(err,safeResults),callback=function(){}}else results[k]=args,async.setImmediate(taskComplete)},requires=task.slice(0,Math.abs(task.length-1))||[],ready=function(){return _reduce(requires,function(a,x){return a&&results.hasOwnProperty(x)},!0)&&!results.hasOwnProperty(k)};if(ready())task[task.length-1](taskCallback,results);else{var listener=function(){ready()&&(removeListener(listener),task[task.length-1](taskCallback,results))};addListener(listener)}})},async.waterfall=function(tasks,callback){if(callback=callback||function(){},tasks.constructor!==Array){var err=new Error("First argument to waterfall must be an array of functions");return callback(err)}if(!tasks.length)return callback();var wrapIterator=function(iterator){return function(err){if(err)callback.apply(null,arguments),callback=function(){};else{var args=Array.prototype.slice.call(arguments,1),next=iterator.next();next?args.push(wrapIterator(next)):args.push(callback),async.setImmediate(function(){iterator.apply(null,args)})}}};wrapIterator(async.iterator(tasks))()};var _parallel=function(eachfn,tasks,callback){if(callback=callback||function(){},tasks.constructor===Array)eachfn.map(tasks,function(fn,callback){fn&&fn(function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),callback.call(null,err,args)})},callback);else{var results={};eachfn.each(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),results[k]=args,callback(err)})},function(err){callback(err,results)})}};async.parallel=function(tasks,callback){_parallel({map:async.map,each:async.each},tasks,callback)},async.parallelLimit=function(tasks,limit,callback){_parallel({map:_mapLimit(limit),each:_eachLimit(limit)},tasks,callback)},async.series=function(tasks,callback){if(callback=callback||function(){},tasks.constructor===Array)async.mapSeries(tasks,function(fn,callback){fn&&fn(function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),callback.call(null,err,args)})},callback);else{var results={};async.eachSeries(_keys(tasks),function(k,callback){tasks[k](function(err){var args=Array.prototype.slice.call(arguments,1);args.length<=1&&(args=args[0]),results[k]=args,callback(err)})},function(err){callback(err,results)})}},async.iterator=function(tasks){var makeCallback=function(index){var fn=function(){return tasks.length&&tasks[index].apply(null,arguments),fn.next()};return fn.next=function(){return index<tasks.length-1?makeCallback(index+1):null},fn};return makeCallback(0)},async.apply=function(fn){var args=Array.prototype.slice.call(arguments,1);return function(){return fn.apply(null,args.concat(Array.prototype.slice.call(arguments)))}};var _concat=function(eachfn,arr,fn,callback){var r=[];eachfn(arr,function(x,cb){fn(x,function(err,y){r=r.concat(y||[]),cb(err)})},function(err){callback(err,r)})};async.concat=doParallel(_concat),async.concatSeries=doSeries(_concat),async.whilst=function(test,iterator,callback){test()?iterator(function(err){return err?callback(err):(async.whilst(test,iterator,callback),void 0)}):callback()},async.doWhilst=function(iterator,test,callback){iterator(function(err){return err?callback(err):(test()?async.doWhilst(iterator,test,callback):callback(),void 0)})},async.until=function(test,iterator,callback){test()?callback():iterator(function(err){return err?callback(err):(async.until(test,iterator,callback),void 0)})},async.doUntil=function(iterator,test,callback){iterator(function(err){return err?callback(err):(test()?callback():async.doUntil(iterator,test,callback),void 0)})},async.queue=function(worker,concurrency){function _insert(q,data,pos,callback){data.constructor!==Array&&(data=[data]),_each(data,function(task){var item={data:task,callback:"function"==typeof callback?callback:null};pos?q.tasks.unshift(item):q.tasks.push(item),q.saturated&&q.tasks.length===concurrency&&q.saturated(),async.setImmediate(q.process)})}void 0===concurrency&&(concurrency=1);var workers=0,q={tasks:[],concurrency:concurrency,saturated:null,empty:null,drain:null,push:function(data,callback){_insert(q,data,!1,callback)},unshift:function(data,callback){_insert(q,data,!0,callback)},process:function(){if(workers<q.concurrency&&q.tasks.length){var task=q.tasks.shift();q.empty&&0===q.tasks.length&&q.empty(),workers+=1;var next=function(){workers-=1,task.callback&&task.callback.apply(task,arguments),q.drain&&q.tasks.length+workers===0&&q.drain(),q.process()},cb=only_once(next);worker(task.data,cb)}},length:function(){return q.tasks.length},running:function(){return workers}};return q},async.cargo=function(worker,payload){var working=!1,tasks=[],cargo={tasks:tasks,payload:payload,saturated:null,empty:null,drain:null,push:function(data,callback){data.constructor!==Array&&(data=[data]),_each(data,function(task){tasks.push({data:task,callback:"function"==typeof callback?callback:null}),cargo.saturated&&tasks.length===payload&&cargo.saturated()}),async.setImmediate(cargo.process)},process:function process(){if(!working){if(0===tasks.length)return cargo.drain&&cargo.drain(),void 0;var ts="number"==typeof payload?tasks.splice(0,payload):tasks.splice(0),ds=_map(ts,function(task){return task.data});cargo.empty&&cargo.empty(),working=!0,worker(ds,function(){working=!1;var args=arguments;_each(ts,function(data){data.callback&&data.callback.apply(null,args)}),process()})}},length:function(){return tasks.length},running:function(){return working}};return cargo};var _console_fn=function(name){return function(fn){var args=Array.prototype.slice.call(arguments,1);fn.apply(null,args.concat([function(err){var args=Array.prototype.slice.call(arguments,1);"undefined"!=typeof console&&(err?console.error&&console.error(err):console[name]&&_each(args,function(x){console[name](x)}))}]))}};async.log=_console_fn("log"),async.dir=_console_fn("dir"),async.memoize=function(fn,hasher){var memo={},queues={};hasher=hasher||function(x){return x};var memoized=function(){var args=Array.prototype.slice.call(arguments),callback=args.pop(),key=hasher.apply(null,args);key in memo?callback.apply(null,memo[key]):key in queues?queues[key].push(callback):(queues[key]=[callback],fn.apply(null,args.concat([function(){memo[key]=arguments;var q=queues[key];delete queues[key];for(var i=0,l=q.length;l>i;i++)q[i].apply(null,arguments)}])))};return memoized.memo=memo,memoized.unmemoized=fn,memoized},async.unmemoize=function(fn){return function(){return(fn.unmemoized||fn).apply(null,arguments)}},async.times=function(count,iterator,callback){for(var counter=[],i=0;count>i;i++)counter.push(i);return async.map(counter,iterator,callback)},async.timesSeries=function(count,iterator,callback){for(var counter=[],i=0;count>i;i++)counter.push(i);return async.mapSeries(counter,iterator,callback)},async.compose=function(){var fns=Array.prototype.reverse.call(arguments);return function(){var that=this,args=Array.prototype.slice.call(arguments),callback=args.pop();async.reduce(fns,args,function(newargs,fn,cb){fn.apply(that,newargs.concat([function(){var err=arguments[0],nextargs=Array.prototype.slice.call(arguments,1);cb(err,nextargs)}]))},function(err,results){callback.apply(that,[err].concat(results))})}};var _applyEach=function(eachfn,fns){var go=function(){var that=this,args=Array.prototype.slice.call(arguments),callback=args.pop();return eachfn(fns,function(fn,cb){fn.apply(that,args.concat([cb]))},callback)};if(arguments.length>2){var args=Array.prototype.slice.call(arguments,2);return go.apply(this,args)}return go};async.applyEach=doParallel(_applyEach),async.applyEachSeries=doSeries(_applyEach),async.forever=function(fn,callback){function next(err){if(err){if(callback)return callback(err);throw err}fn(next)}next()},"undefined"!=typeof define&&define.amd?define([],function(){return async}):"undefined"!=typeof module&&module.exports?module.exports=async:root.async=async}()},{__browserify_process:15}],15:[function(require,module){var process=module.exports={};process.nextTick=function(){var canSetImmediate="undefined"!=typeof window&&window.setImmediate,canPost="undefined"!=typeof window&&window.postMessage&&window.addEventListener;if(canSetImmediate)return function(f){return window.setImmediate(f)};if(canPost){var queue=[];
return window.addEventListener("message",function(ev){if(ev.source===window&&"process-tick"===ev.data&&(ev.stopPropagation(),queue.length>0)){var fn=queue.shift();fn()}},!0),function(fn){queue.push(fn),window.postMessage("process-tick","*")}}return function(fn){setTimeout(fn,0)}}(),process.title="browser",process.browser=!0,process.env={},process.argv=[],process.binding=function(){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(){throw new Error("process.chdir is not supported")}},{}],16:[function(require,module){"use strict";var prepare=require("./lib/prepare"),replicate=require("./lib/replicate"),uuid=require("./deps/uuid");module.exports=function(config){return config=config||{},config.id=config.id||uuid(),config.batch_size=config.batch_size||100,config.max_requests=config.max_requests||4,config.heartbeat=config.heartbeat||1e4,{id:function(){return config.id},replicate:function(options,callback){if(options=options||{},callback=callback||function(){},!options.source)throw"Need a source";if(!options.target)throw"Need a target";var state={session_id:uuid(),start_time:new Date,missing_checked:0,missing_found:0,docs_read:0,docs_written:0,doc_write_failures:0};return prepare(options,config,state,function(err){return err?callback(err):(replicate(options,config,state,callback),void 0)}),{cancel:function(callback){"function"==typeof callback&&callback()}}}}}},{"./deps/uuid":2,"./lib/prepare":3,"./lib/replicate":8}]},{},[16]);